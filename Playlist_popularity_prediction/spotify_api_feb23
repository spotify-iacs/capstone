{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# IACS Capstone Project\n",
    "## Team Spotify 1: Playlist Prediction\n",
    "### Midterm 1: Data Exploration\n",
    "#### Omar Abboud, Sonu Mehta, Laura Ware\n",
    "This document contains preliminary data exploration on the Spotify API, specifically via the Python module \"spotipy,\" which allows easy access to Spotify API data given a company-issued API key."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 72,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "import spotipy\n",
    "import spotipy.util as util\n",
    "from spotipy.oauth2 import SpotifyClientCredentials\n",
    "import sys"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Authentication"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "client_credentials_manager = SpotifyClientCredentials(client_id='df846cfd28e745178054587b3484f91c', client_secret='e3d39fc92a954e028ff1490288f3fe5c')\n",
    "sp = spotipy.Spotify(client_credentials_manager=client_credentials_manager)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Playlist DataFrame Generation\n",
    "The below code generates a DataFrame with all the playlists that were generated by the user ID \"spotify\" - in other words, those created by the company for wide distribution and recommendation. Alongside each playlist ID, we have extracted the mean popularity of the playlist's tracks, the number of followers of the playlist, as well as the playlist's name."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "//anaconda/lib/python2.7/site-packages/numpy/core/_methods.py:59: RuntimeWarning: Mean of empty slice.\n",
      "  warnings.warn(\"Mean of empty slice.\", RuntimeWarning)\n"
     ]
    }
   ],
   "source": [
    "names = []\n",
    "total_tracks = []\n",
    "followers = []\n",
    "popularity_means = []\n",
    "\n",
    "playlists = sp.user_playlists('spotify', limit=50, offset=0)\n",
    "\n",
    "while playlists:\n",
    "    for i, playlist in enumerate(playlists['items']):\n",
    "        try:\n",
    "            metadata = sp.user_playlist('spotify', playlist_id=playlist['id'],fields='followers.total,tracks.items(added_at, track.popularity, track.name)')\n",
    "            popularities = np.empty(len(metadata['tracks']['items']))\n",
    "            for index, item in enumerate(metadata['tracks']['items']): \n",
    "                popularities[index] = item['track']['popularity']\n",
    "            popularity_means.append(popularities.mean())\n",
    "            followers.append(metadata['followers']['total'])\n",
    "            names.append(playlist['name'])\n",
    "            total_tracks.append(playlist['tracks']['total'])\n",
    "            #print(\"%4d %s\" % (i + 1 + playlists['offset'], playlist['name']))\n",
    "        except:\n",
    "            a=0\n",
    "            #print(\"NO METADATA\")\n",
    "    if playlists['next']:\n",
    "        playlists = sp.next(playlists)\n",
    "    else:\n",
    "        playlists = None\n",
    "        break"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {
    "collapsed": true
   },
   "outputs": [],
   "source": [
    "playlist_data = pd.DataFrame({\n",
    "     'names': names,\n",
    "     'total_tracks': total_tracks,\n",
    "     'followers': followers,\n",
    "     'mean_popularity': popularity_means,\n",
    "    })"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>followers</th>\n",
       "      <th>mean_popularity</th>\n",
       "      <th>names</th>\n",
       "      <th>total_tracks</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>13468811</td>\n",
       "      <td>79.820000</td>\n",
       "      <td>Today's Top Hits</td>\n",
       "      <td>50</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>5705788</td>\n",
       "      <td>72.720000</td>\n",
       "      <td>Rap Caviar</td>\n",
       "      <td>50</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3887591</td>\n",
       "      <td>60.500000</td>\n",
       "      <td>electroNOW</td>\n",
       "      <td>52</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>2450946</td>\n",
       "      <td>51.569444</td>\n",
       "      <td>Afternoon Acoustic</td>\n",
       "      <td>72</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2575182</td>\n",
       "      <td>57.870000</td>\n",
       "      <td>Peaceful Piano</td>\n",
       "      <td>149</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   followers  mean_popularity               names  total_tracks\n",
       "0   13468811        79.820000    Today's Top Hits            50\n",
       "1    5705788        72.720000          Rap Caviar            50\n",
       "2    3887591        60.500000          electroNOW            52\n",
       "3    2450946        51.569444  Afternoon Acoustic            72\n",
       "4    2575182        57.870000      Peaceful Piano           149"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "playlist_data.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Track DataFrame Generation\n",
    "In the below code, we perform a deeper analysis of one sample playlist, \"Today's Top Hits.\" We obtain the list of tracks from the playlist and make an API call to obtain more detailed information about each track, particularly audio features. We also include a \"sequence\" column that indicates where in the playlist that particular track is located."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 79,
   "metadata": {
    "collapsed": false,
    "scrolled": true
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>id</th>\n",
       "      <th>name</th>\n",
       "      <th>external_ids</th>\n",
       "      <th>artists</th>\n",
       "      <th>duration_ms</th>\n",
       "      <th>explicit</th>\n",
       "      <th>track_number</th>\n",
       "      <th>popularity</th>\n",
       "      <th>acousticness</th>\n",
       "      <th>danceability</th>\n",
       "      <th>energy</th>\n",
       "      <th>instrumentalness</th>\n",
       "      <th>key</th>\n",
       "      <th>liveness</th>\n",
       "      <th>loudness</th>\n",
       "      <th>mode</th>\n",
       "      <th>tempo</th>\n",
       "      <th>time_signature</th>\n",
       "      <th>valence</th>\n",
       "      <th>sequence</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1dNIEtp7AY3oDAKCGg2XkH</td>\n",
       "      <td>Something Just Like This</td>\n",
       "      <td>{u'isrc': u'USQX91700278'}</td>\n",
       "      <td>[{u'name': u'The Chainsmokers', u'external_url...</td>\n",
       "      <td>247626</td>\n",
       "      <td>False</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0306</td>\n",
       "      <td>0.607</td>\n",
       "      <td>0.649</td>\n",
       "      <td>0.000025</td>\n",
       "      <td>11</td>\n",
       "      <td>0.1740</td>\n",
       "      <td>-6.695</td>\n",
       "      <td>0.0362</td>\n",
       "      <td>102.996</td>\n",
       "      <td>4</td>\n",
       "      <td>0.470</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>12GEpg2XOPyqk03JZEZnJs</td>\n",
       "      <td>It Ain’t Me (with Selena Gomez)</td>\n",
       "      <td>{u'isrc': u'SEBGA1700015'}</td>\n",
       "      <td>[{u'name': u'Kygo', u'external_urls': {u'spoti...</td>\n",
       "      <td>220780</td>\n",
       "      <td>False</td>\n",
       "      <td>1</td>\n",
       "      <td>76</td>\n",
       "      <td>0.0905</td>\n",
       "      <td>0.648</td>\n",
       "      <td>0.532</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0831</td>\n",
       "      <td>-6.597</td>\n",
       "      <td>0.0746</td>\n",
       "      <td>99.983</td>\n",
       "      <td>4</td>\n",
       "      <td>0.497</td>\n",
       "      <td>2</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>6AeQlMyRzvSl1nkFztZyKl</td>\n",
       "      <td>Issues</td>\n",
       "      <td>{u'isrc': u'USUM71615691'}</td>\n",
       "      <td>[{u'name': u'Julia Michaels', u'external_urls'...</td>\n",
       "      <td>176346</td>\n",
       "      <td>False</td>\n",
       "      <td>1</td>\n",
       "      <td>82</td>\n",
       "      <td>0.4160</td>\n",
       "      <td>0.704</td>\n",
       "      <td>0.423</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>8</td>\n",
       "      <td>0.0607</td>\n",
       "      <td>-6.792</td>\n",
       "      <td>0.0862</td>\n",
       "      <td>113.962</td>\n",
       "      <td>4</td>\n",
       "      <td>0.450</td>\n",
       "      <td>3</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>0FE9t6xYkqWXU2ahLh6D8X</td>\n",
       "      <td>Shape of You</td>\n",
       "      <td>{u'isrc': u'GBAHS1600463'}</td>\n",
       "      <td>[{u'name': u'Ed Sheeran', u'external_urls': {u...</td>\n",
       "      <td>233712</td>\n",
       "      <td>False</td>\n",
       "      <td>1</td>\n",
       "      <td>100</td>\n",
       "      <td>0.5810</td>\n",
       "      <td>0.825</td>\n",
       "      <td>0.652</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>0.0931</td>\n",
       "      <td>-3.183</td>\n",
       "      <td>0.0802</td>\n",
       "      <td>95.977</td>\n",
       "      <td>4</td>\n",
       "      <td>0.933</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>3ebXMykcMXOcLeJ9xZ17XH</td>\n",
       "      <td>Scared To Be Lonely</td>\n",
       "      <td>{u'isrc': u'NLM5S1600025'}</td>\n",
       "      <td>[{u'name': u'Martin Garrix', u'external_urls':...</td>\n",
       "      <td>220883</td>\n",
       "      <td>False</td>\n",
       "      <td>1</td>\n",
       "      <td>91</td>\n",
       "      <td>0.0895</td>\n",
       "      <td>0.584</td>\n",
       "      <td>0.540</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>0.2610</td>\n",
       "      <td>-7.786</td>\n",
       "      <td>0.0576</td>\n",
       "      <td>137.972</td>\n",
       "      <td>4</td>\n",
       "      <td>0.190</td>\n",
       "      <td>5</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                       id                             name  \\\n",
       "0  1dNIEtp7AY3oDAKCGg2XkH         Something Just Like This   \n",
       "1  12GEpg2XOPyqk03JZEZnJs  It Ain’t Me (with Selena Gomez)   \n",
       "2  6AeQlMyRzvSl1nkFztZyKl                           Issues   \n",
       "3  0FE9t6xYkqWXU2ahLh6D8X                     Shape of You   \n",
       "4  3ebXMykcMXOcLeJ9xZ17XH              Scared To Be Lonely   \n",
       "\n",
       "                 external_ids  \\\n",
       "0  {u'isrc': u'USQX91700278'}   \n",
       "1  {u'isrc': u'SEBGA1700015'}   \n",
       "2  {u'isrc': u'USUM71615691'}   \n",
       "3  {u'isrc': u'GBAHS1600463'}   \n",
       "4  {u'isrc': u'NLM5S1600025'}   \n",
       "\n",
       "                                             artists  duration_ms explicit  \\\n",
       "0  [{u'name': u'The Chainsmokers', u'external_url...       247626    False   \n",
       "1  [{u'name': u'Kygo', u'external_urls': {u'spoti...       220780    False   \n",
       "2  [{u'name': u'Julia Michaels', u'external_urls'...       176346    False   \n",
       "3  [{u'name': u'Ed Sheeran', u'external_urls': {u...       233712    False   \n",
       "4  [{u'name': u'Martin Garrix', u'external_urls':...       220883    False   \n",
       "\n",
       "   track_number  popularity  acousticness  danceability  energy  \\\n",
       "0             1           0        0.0306         0.607   0.649   \n",
       "1             1          76        0.0905         0.648   0.532   \n",
       "2             1          82        0.4160         0.704   0.423   \n",
       "3             1         100        0.5810         0.825   0.652   \n",
       "4             1          91        0.0895         0.584   0.540   \n",
       "\n",
       "   instrumentalness  key  liveness  loudness    mode    tempo  time_signature  \\\n",
       "0          0.000025   11    0.1740    -6.695  0.0362  102.996               4   \n",
       "1          0.000000    0    0.0831    -6.597  0.0746   99.983               4   \n",
       "2          0.000000    8    0.0607    -6.792  0.0862  113.962               4   \n",
       "3          0.000000    1    0.0931    -3.183  0.0802   95.977               4   \n",
       "4          0.000000    1    0.2610    -7.786  0.0576  137.972               4   \n",
       "\n",
       "   valence  sequence  \n",
       "0    0.470         1  \n",
       "1    0.497         2  \n",
       "2    0.450         3  \n",
       "3    0.933         4  \n",
       "4    0.190         5  "
      ]
     },
     "execution_count": 79,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "playlist_sample = sp.user_playlist('spotify','5FJXhjdILmRA2z5bvz4nzf')['tracks']['items']\n",
    "list_of_tracks = []\n",
    "for a in playlist_sample:\n",
    "    list_of_tracks.append(a['track'])\n",
    "sample = pd.DataFrame(list_of_tracks)[['id','name','external_ids','artists','duration_ms','explicit','track_number','popularity']]\n",
    "features = sp.audio_features(tracks=sample['id'])\n",
    "features_df = pd.DataFrame(features)\n",
    "sample['acousticness'] = features_df['acousticness']\n",
    "sample['danceability'] = features_df['danceability']\n",
    "sample['energy'] = features_df['energy']\n",
    "sample['instrumentalness'] = features_df['instrumentalness']\n",
    "sample['key'] = features_df['key']\n",
    "sample['liveness'] = features_df['liveness']\n",
    "sample['loudness'] = features_df['loudness']\n",
    "sample['mode'] = features_df['speechiness']\n",
    "sample['tempo'] = features_df['tempo']\n",
    "sample['time_signature'] = features_df['time_signature']\n",
    "sample['valence'] = features_df['valence']\n",
    "sample['sequence'] = sample.index + 1\n",
    "sample.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 81,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "sample.to_csv('sample.csv',encoding='utf-8')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [Root]",
   "language": "python",
   "name": "Python [Root]"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 2
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython2",
   "version": "2.7.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 0
}
